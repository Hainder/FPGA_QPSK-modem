本科学的通信读研了没在做，也算是出于兴趣完成的工程，难免有纰漏，后续会抽空将本工程逐渐完善。若有任何问题，非常欢迎您通过邮箱联系我lauchinyuan@yeah.net，共同探讨学习，不过近来比较忙，回复可能稍慢，见谅。

### 关于本项目

本项目是使用Verilog硬件描述语言编写的可以部署在FPGA平台上的正交相移键控（Quadrature Phase Shift Keying，QPSK）调制解调器，使用的调制方案为IQ正交调制，解调端使用Gardner环实现位同步。采用了vivado IP核实现FIR滤波器、乘法器、DDS直接数字频率合成器，这些IP核可以用quartus IP核或者其他厂商提供的IP来替代。

#### 功能说明

整体功能为发送端产生时分秒时钟数据，并将这一数据封装成带有帧头和校验和的数据帧，每一个数据帧设定为40bit，即帧头(8bit)+时(8bit)+分(8bit)+秒(8bit)+校验和(8bit)，通过QPSK调制器将这一数据调制成QPSK信号。接收端接受这一信号，并进行载波同步和位同步，抽样判决得到解调后的二进制数据，最后解析这一数据，在接收端实现时钟数据的数码管动态显示。本项目的核心为QPSK调制解调器，具体传送的数据可以自定义，并不一定是时钟数据。

#### 模块结构

本工程RTL视图如图1所示

![RTL视图](image/RTL.png)

<center>图1. RTL视图</center>

各个模块的功能解释如下：

- clk_gen:时钟生成模块，产生时分秒时钟信号，用于后续生成40bit原始数据，在设计中每秒更新一次数据。
- data_gen:数据生成模块，结合所设定的帧头，时钟数据，计算校验和，并生成40bit数据
- qpsk_mod:调制模块，其主要子模块有
  - para2ser:将40bit并行数据转换为串行数据流，在本设计中高位先发
  - iq_div:将串行数据流依据其奇偶位置，分为I(正交)、Q(同向)两路
  - rcosfilter:升余弦滤波器，使用FIR滤波器实现，对I、Q两路数据进行成形滤波
  - dds:直接数字频率合成信号发生器，产生正弦、余弦载波
- qpsk_demod:解调模块，其主要子模块有
  - gardner_sync:Gardner环，用于实现位同步，判断最佳的抽样判决点，并进行抽样判决，输出抽判数据，gardner环主要的子模块有：
    - interpolate_filter:内插滤波器，计算内插值
    - gardner_ted:Gardner:定时误差检测，包含环形滤波器
    - nco：nco递减计数模块，生成抽样判决标志信号
  - dds:直接数字频率合成信号发生器，产生正弦、余弦载波
  - iq_comb:将抽样判决后的I、Q两路数据重新整合成一路串行数据输出
  - data_valid:数据有效性检测模块，检测帧头和校验和是否正确，若正确，输出最终的40bit数据结果
- time_display:时钟数据显示模块，依据收到的40bit数据，解析时钟信息，并在数码管上显示，对数据个位和十位的分离，采用了bcd编码方案。

### 设计思路

#### QPSK基本原理

QPSK全称为正交相移键控（Quadrature Phase Shift Keying），简单来说就是利用四种不同的相位来代表不同的信息的数字调制解调技术。其信号表示为：

$$S_i(t) = Acos(\omega_ct+\theta_i),i=0,1,2,3$$

#### MATLAB仿真及参数设定

在整体QPSK调制解调过程中，存在成型滤波、低通滤波等滤波过程，这些滤波器参数的设置影响了QPSK调制解调的性能，同时，QPSK的码元速率、载波频率等因素也会影响到通信质量。所以在编写Verilog代码前，通过编写MATLAB仿真程序，对QPSK调制解调的基本过程进行仿真，以确认相关参数的设计的正确性。

通过MATLAB仿真和实际功能需求，确定本设计的相关参数如下：

- 码元速率：5Kbit/s
- 调制端载波频率：50kHz
- 帧长度：40bit
- 采样率：500kHz
- 成形滤波器
  - 截止频率：2kHz
  - FIR阶数：40阶
- 低通滤波器
  - 截止频率：8kHz
  - FIR阶数：30阶

综上，每秒可以传送的帧数为：

$$N_f =500000 \div (40\times 100)=125$$

#### 调制端设计

对于调制过程，其结构如图2所示：

![QPSK调制器结构](image/mod_structure.png)

<center>图2. QPSK调制器结构</center>

将I、Q两路数据流转换为双极性信号(+1/-1)，分别与余弦信号、正弦信号相乘，然后再相加，得到的信号表达式为：

$$S_i(t)=Icos(\omega_ct)+Qsin(\omega_ct)$$

得到的信号与I、Q两路双极性数据之间的对应关系如表1所示，即通过两路同频的正余弦载波信号的相加可以实现混合信号的四个不同相位。

<center> 表1. I、Q数据与QPSK调制信号的映射</center>

$$
\begin{array}{|c|c|c|}
\hline
{I} & {Q} & {S_i(t)}  \\
\hline
{+1} & {-1} & {\sqrt{2}cos(2\omega_ct+\pi/4)} \\
\hline
{-1} & {-1} & {\sqrt{2}cos(2\omega_ct+3\pi/4)} \\
\hline
{-1} & {+1} & {\sqrt{2}cos(2\omega_ct+5\pi/4)} \\
\hline
{+1} & {+1} & {\sqrt{2}cos(2\omega_ct+7\pi/4)} \\
\hline
\end{array}
$$

##### IQ分流

输入的原始数据流的每一bit是具有确定周期(本设计中为0.2ms)的比特流，QPSK调制过程需要将这些bit流依据其所在位置分为I(正交)、Q(同向)两路，在RTL设计中，依据所用的采样时钟频率(本设计中为500kHz)配置计数器，每一个采样时钟自加1，当计数器计数一定次数(本设计中为100次)，即完成一个通道一个bit的采样，接着继续采样，但将采样数据输出到另一通道，并重新开始计数，往复循环。在FPGA实现中，IQ分流模块和产生数据流的data_gen模块的复位信号`rst_n`是同一个信号，在理想条件下，两个模块同时离开复位模式，开启正常工作，故可以确保IQ分流模块的计数器是从数据边沿开始计数，计到100正好需要转换数据通道。

##### 成形滤波

QPSK调制过程中的关键部件是成形滤波器，成形滤波的作用是平滑波形效果，提高频谱的利用率，并消除码间串扰。

本设计中成型滤波为平方根升余弦低通FIR滤波器。通过MATLAB Filter Designer工具，配置相应的滤波器参数(如滤波器阶数，窗函数等)可以生成滤波器抽头系数，将生成的抽头系数文件(例如Vivado支持的coe文件)导入到FIR滤波器IP核，并配置相应的IP核参数，即可实例化调用相应IP实现成形滤波器。对于本设计中的其他滤波器也是同样的设计思路。

##### 数字上变频

依照表1中的式子，将成形滤波后的I、Q两路数据与分别与余弦、正弦载波相乘，将基带信号调制到中频，并将相乘后两路信号叠加，即可得到中频的QPSK调制信号，本设计中乘法器使用vivado提供的乘法器IP核实现。

#### 解调端设计

对于解调过程，其结构如图3所示。

![demo_structure](image/demo_structure.png)

<center>图3. QPSK调制器结构</center>

##### 数字下变频

QPSK解调器接收到ADC采集的信号后，首先要进行数字下变频，即对接收的中频信号进行频谱搬移，使其恢复为低频信号，假设QPSK信号为：

$$QPSK(t)=cos(\omega_0t+\theta)$$

在QPSK解调端分别乘以正余弦载波后，有

$$I(t)=QPSK(t)cos(\omega_0t+\phi)=\frac{1}{2}[cos(\phi-\theta)+cos(2\omega_0t+\phi+\theta)]$$

$$Q(t)=QPSK(t)sin(\omega_0t+\phi)=\frac{1}{2}[sin(\phi-\theta)+sin(2\omega_0t+\phi+\theta)]$$

通过低通滤波器滤除二倍频率分量后，即得到低频分量，实现下变频。

$$I'(t)=\frac{1}{2}cos(\phi-\theta)$$

$$Q'(t)=\frac{1}{2}sin(\phi-\theta)$$

##### Costas环载波同步



##### Gardner位同步

在实际通信系统中，通信数据的传播具有时延，数据发送方和接收方也存在时钟偏差，使得接收端难以直接找到符号的最佳抽样判决点来进行抽样判决，位同步的目的便是找到接收信号的最佳抽样判决点，在数字通信技术中，有多种位同步方案，本设计采用Gardner loop来实现位同步。Gardner环的结构如图4所示。

内插滤波器依据输入的I路或Q路数据的相邻几个点来计算内插值，内插滤波器的输出传递给定时误差检测器，定时误差检测器通过Gardner算法计算出定时误差，并将这一值通过环路滤波器滤除高频分量后反馈传给NCO，调整NCO递减的速度，使得NCO可以自适应地产生抽判标志信号`strobe_flag`,从而达到自适应寻找最佳抽样判决点的目的。

![Gardner loop](image/gardner.png)

<center>图4. QPSK调制器结构</center>

###### NCO压控振荡器

在Gardner环中，NCO是一个相位递减单元，NCO寄存器的值每个时钟周期减小$\omega(m)$，而当NCO寄存器的值递减到<0时，将其值+1，并输出一个`strobe_flag`信号代表最佳抽样判决点及最佳抽样判决点中间的点。正常情况下，最佳抽样判决点在符号的中间位置，但由于时钟偏差和收发端延时会有时间上的偏移，通过Gardner定时误差检测法来计算定时误差，通过环路滤波器后得到调整后的$\omega(m)$，通过控制$\omega(m)$即可调整NCO递减的速度，从而自适应地改变抽样判决点的位置。

###### 内插滤波器

内插滤波器依据输入的I路或Q路数据的相邻几个点来计算内插值，其中重要的输入参数为$\mu_k$,代表分数间隔，在本设计中内插滤波器模块不断计算内插值，本设计采用Farrow结构的插值滤波器，为节省运算资源，其中的乘法运算通过移位操作和加法操作来完成。其输入输出关系为：

$$f_1=0.5x(m)-0.5x(m-1)-0.5x(m-2)+0.5x(m-3)$$

$$f_2=-0.5x(m)+1.5x(m-1)-0.5x(m-2)-0.5x(m-3)$$

$$f_3=x(m-2)$$

$$y(k)=f_1\mu_k^2+f_2\mu_k+f_3$$

###### Gardner定时误差检测器

Gardner定时误差检测算法是一种非数据辅助的误差检测算法，在该算法中，经过内插器内插后的信号符号需要采集两个点，一个点是最佳采样点，称为`strobe`，另一个是两个最佳采样点中间的点称为`midstrobe`，算法示意图如图所示。

![Gardner loop](image/Gardner_algorithm.png)

<center> 图3. Gardner定时误差检测算法示意图</center>

结合示意图，对于一路信号的定时误差的计算公式为：

$$\tau(n)=y(n-1/2)\times[y(n)-y(n-1)]$$

本设计中为了节省计算资源，使用使用峰值符号代替峰值，同时使用I、Q两路信号来计算定时误差，则误差公式修正为：

$$\tau(n)=y_I(n-1/2)\times[sign(y_I(n))-sign(y_I(n-1))]+y_Q(n-1/2)\times[sign(y_Q(n))-sign(y_Q(n-1))]$$

该式子具有明显的物理意义，即当两个采样点都位于符号中央时，中间采样数据为0，则输出误差为0。对于图(b)，本地时钟超前，定时误差为负值，而对于图(c)的情况，本地时钟滞后，定时误差为正值。所以Gardner定时误差检测算法可以确定定时误差的大小和方向，这一信息可以用于后续调整NCO的溢出频率，从而调整抽样判决点的位置。

###### 环路滤波器

Gardner环中的环路滤波器与Costas环中的环路滤波器结构相似,其结构如图所示，实质上是一个IIR滤波器，作用是消除定时误差检测器输出的高频分量。

![loop_filter](image/loop_filter.png)

<center> 图3. 二阶环路滤波器结构</center>

为了在FPGA中用移位运算代替乘除运算并简化设计，环路滤波器的传递函数为：

$$H(z)=C_1+\frac{C_2Z^{-1}}{1-Z^{-1}}$$

$C_1$、$C_2$的计算式子为：

$$C_1=\frac{8B_LT_s}{3}$$

$$C_2=\frac{32(B_LT_s)^2}{3}$$

其中，$B_LT_S$单边噪声带宽与采样周期的乘积，一般要求$B_LT_S\leq 0.1$，在Gardner环路中，设定$C_1=2^{-8}$，$C_2=0$，这样可以方便地使用移位操作来进行运算，节省了FPGA的运算资源。

### 仿真及实验部署

本设计已在Xilinx Kintex-7 FPGA硬件平台上成功部署，在单个FPGA上实现了QPSK调制解调过程。硬件实验平台使用的是博宸精芯Kintex-7基础板开发板，芯片型号为XC7K325T-2FFG676，实验环境如图所示。

<img src="image/FPGA_platform.jpg" alt="FPGA_platform" />

<center> 图4. FPGA实验平台</center>

从实际实验上看，在FPGA程序烧录后，开始的三秒钟数据从0秒到1秒到3秒再马上回到2秒，中间误判了一个3秒的数据，同样地在15s之前的数据也偶尔有错，15s之后的数据基本上都可以正常显示，项目文件夹中附有演示视频。

首先通过MATLAB跑通QPSK调制解调的基本流程，方便确定一些基本参数（如滤波器阶数等方案），详细MATLAB代码可见本工程所附文件夹，MATLAB仿真的相关结果如图所示。

完成QPSK调制解调的基本流程的实现后，编写了testbench文件对本设计的各个模块进行了仿真，仿真工具为Modelsim，以下分模块进行分析。

#### 调制模块仿真

对于QPSK_mod模块，



### 进展规划

- [x] 完成QPSK调制解调过程MATLAB仿真
- [x] verilog实现QPSK调制解调基本过程
- [x] 实现QPSK解调端的Gardner位同步
- [x] 实现数字时钟数据生成和显示
- [x] 部署在单一FPGA硬件平台上，测试调制解调过程的正确性
- [ ] 实现costas环载波同步
- [ ] 加入噪声，仿真加噪后结果
- [ ] 新增mod branch和demod branch,将调制端和解调端分开，并在两台FPGA硬件设备上部署
- [ ] 编写blog，详细讲述本项目的实施细节和QPSK原理
